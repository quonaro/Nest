name: Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            binary_name: nest
            platform_name: linux
          - os: ubuntu-latest
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            binary_name: nest
            platform_name: linux
          - os: macos-latest
            arch: x86_64
            target: x86_64-apple-darwin
            binary_name: nest
            platform_name: macos
          - os: macos-latest
            arch: aarch64
            target: aarch64-apple-darwin
            binary_name: nest
            platform_name: macos
          - os: windows-latest
            arch: x86_64
            target: x86_64-pc-windows-msvc
            binary_name: nest.exe
            platform_name: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux aarch64)
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Configure linker for aarch64
        if: matrix.os == 'ubuntu-latest' && matrix.arch == 'aarch64'
        run: |
          mkdir -p .cargo
          cat >> .cargo/config.toml <<EOF
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          if [ ! -f "$BINARY_PATH" ]; then
            echo "Error: Binary not found at $BINARY_PATH"
            exit 1
          fi
          if [ "${{ matrix.arch }}" == "aarch64" ] && [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            aarch64-linux-gnu-strip "$BINARY_PATH"
          else
            strip "$BINARY_PATH"
          fi

      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          ARCHIVE_NAME="nest-${{ matrix.platform_name }}-${{ matrix.arch }}.tar.gz"
          CHECKSUM_NAME="${ARCHIVE_NAME}.sha256"
          
          if [ ! -f "$BINARY_PATH" ]; then
            echo "Error: Binary not found at $BINARY_PATH"
            exit 1
          fi
          
          cd target/${{ matrix.target }}/release
          tar czf ../../../../${ARCHIVE_NAME} ${{ matrix.binary_name }}
          if [ $? -ne 0 ]; then
            echo "Error: Failed to create archive ${ARCHIVE_NAME}"
            exit 1
          fi
          cd ../../../..
          
          if [ ! -f "${ARCHIVE_NAME}" ]; then
            echo "Error: Archive ${ARCHIVE_NAME} was not created"
            exit 1
          fi
          
          sha256sum ${ARCHIVE_NAME} > ${CHECKSUM_NAME} || shasum -a 256 ${ARCHIVE_NAME} > ${CHECKSUM_NAME}
          if [ $? -ne 0 ]; then
            echo "Error: Failed to create checksum ${CHECKSUM_NAME}"
            exit 1
          fi
          
          echo "Created archive: ${ARCHIVE_NAME}"
          echo "Created checksum: ${CHECKSUM_NAME}"
          ls -lh ${ARCHIVE_NAME} ${CHECKSUM_NAME}

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $BINARY_PATH = "target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          $ARCHIVE_NAME = "nest-${{ matrix.platform_name }}-${{ matrix.arch }}.zip"
          $CHECKSUM_NAME = "${ARCHIVE_NAME}.sha256"
          
          if (-not (Test-Path $BINARY_PATH)) {
            Write-Error "Error: Binary not found at $BINARY_PATH"
            exit 1
          }
          
          cd target/${{ matrix.target }}/release
          Compress-Archive -Path ${{ matrix.binary_name }} -DestinationPath ../../../../${ARCHIVE_NAME} -Force
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Error: Failed to create archive ${ARCHIVE_NAME}"
            exit 1
          }
          cd ../../../..
          
          if (-not (Test-Path ${ARCHIVE_NAME})) {
            Write-Error "Error: Archive ${ARCHIVE_NAME} was not created"
            exit 1
          }
          
          Get-FileHash -Algorithm SHA256 ${ARCHIVE_NAME} | ForEach-Object { "$($_.Hash)  $($_.Path)" } | Out-File -Encoding utf8 ${CHECKSUM_NAME}
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Error: Failed to create checksum ${CHECKSUM_NAME}"
            exit 1
          }
          
          Write-Host "Created archive: ${ARCHIVE_NAME}"
          Write-Host "Created checksum: ${CHECKSUM_NAME}"
          Get-ChildItem ${ARCHIVE_NAME}, ${CHECKSUM_NAME} | Format-Table Name, Length

      - name: Verify files before upload (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          ARCHIVE="nest-${{ matrix.platform_name }}-${{ matrix.arch }}.tar.gz"
          CHECKSUM="${ARCHIVE}.sha256"
          
          echo "Checking for files:"
          echo "  Archive: ${ARCHIVE}"
          echo "  Checksum: ${CHECKSUM}"
          
          if [ ! -f "${ARCHIVE}" ]; then
            echo "Error: Archive ${ARCHIVE} not found"
            exit 1
          fi
          
          if [ ! -f "${CHECKSUM}" ]; then
            echo "Error: Checksum ${CHECKSUM} not found"
            exit 1
          fi
          
          echo "Files verified:"
          ls -lh ${ARCHIVE} ${CHECKSUM}

      - name: Verify files before upload (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $ARCHIVE = "nest-${{ matrix.platform_name }}-${{ matrix.arch }}.zip"
          $CHECKSUM = "${ARCHIVE}.sha256"
          
          Write-Host "Checking for files:"
          Write-Host "  Archive: $ARCHIVE"
          Write-Host "  Checksum: $CHECKSUM"
          
          if (-not (Test-Path $ARCHIVE)) {
            Write-Error "Error: Archive $ARCHIVE not found"
            exit 1
          }
          
          if (-not (Test-Path $CHECKSUM)) {
            Write-Error "Error: Checksum $CHECKSUM not found"
            exit 1
          }
          
          Write-Host "Files verified:"
          Get-ChildItem $ARCHIVE, $CHECKSUM | Format-Table Name, Length

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nest-${{ matrix.platform_name }}-${{ matrix.arch }}
          path: |
            nest-${{ matrix.platform_name }}-${{ matrix.arch }}.*
          retention-days: 30
          if-no-files-found: error

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "=== Checking artifacts structure ==="
          if [ ! -d "artifacts" ]; then
            echo "Error: artifacts directory does not exist. No artifacts were downloaded."
            echo "This usually means all build jobs failed. Cannot create release."
            exit 1
          fi
          
          echo "=== Artifacts directory contents ==="
          find artifacts -type f -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" | sort || echo "No artifacts found"
          
          echo "=== Artifacts by platform ==="
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "Platform: $(basename $dir)"
              ls -lh "$dir" || echo "  No files in this directory"
            fi
          done
          
          # Check if we have any files at all
          if [ -z "$(find artifacts -type f)" ]; then
            echo "Error: artifacts directory is empty. Cannot create release."
            exit 1
          fi

      - name: Prepare release files
        run: |
          mkdir -p release-files
          
          # Copy all archives and checksums to release-files directory
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec cp {} release-files/ \;
          
          echo "=== Release files prepared ==="
          ls -lh release-files/
          
          # Verify we have files
          if [ -z "$(ls -A release-files)" ]; then
            echo "Error: No files prepared for release."
            exit 1
          fi
          
          # Count files
          ARCHIVE_COUNT=$(find release-files -name "*.tar.gz" -o -name "*.zip" | wc -l)
          CHECKSUM_COUNT=$(find release-files -name "*.sha256" | wc -l)
          echo "Archives: $ARCHIVE_COUNT"
          echo "Checksums: $CHECKSUM_COUNT"
          
          if [ "$ARCHIVE_COUNT" -eq 0 ]; then
            echo "Error: No archives found for release."
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## Release v${{ steps.get_version.outputs.version }}

            ### Installation

            **Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/quonaro/nest/main/install.sh | sh
            ```

            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/quonaro/nest/main/install.ps1 | iex
            ```

            ### Downloads

            Pre-built binaries for all platforms are available below.

            ### Checksums

            All files include SHA256 checksums for verification.
          files: release-files/*
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        run: |
          rm -rf artifacts/ release-files/

