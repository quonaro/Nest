name: Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            binary_name: nest
            platform_name: linux
          - os: ubuntu-latest
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            binary_name: nest
            platform_name: linux
          - os: macos-latest
            arch: x86_64
            target: x86_64-apple-darwin
            binary_name: nest
            platform_name: macos
          - os: macos-latest
            arch: aarch64
            target: aarch64-apple-darwin
            binary_name: nest
            platform_name: macos
          - os: windows-latest
            arch: x86_64
            target: x86_64-pc-windows-msvc
            binary_name: nest.exe
            platform_name: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux aarch64)
        if: matrix.platform_name == 'linux' && matrix.arch == 'aarch64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Configure linker for aarch64
        if: matrix.platform_name == 'linux' && matrix.arch == 'aarch64'
        run: |
          mkdir -p .cargo
          cat >> .cargo/config.toml <<EOF
          [target.aarch64-unknown-linux-gnu]
          linker = "aarch64-linux-gnu-gcc"
          EOF

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          if [ ! -f "$BINARY_PATH" ]; then
            echo "Error: Binary not found at $BINARY_PATH"
            exit 1
          fi
          if [ "${{ matrix.arch }}" == "aarch64" ] && [ "${{ matrix.platform_name }}" == "linux" ]; then
            aarch64-linux-gnu-strip "$BINARY_PATH"
          else
            strip "$BINARY_PATH"
          fi

      - name: Create archive (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          set -e
          BINARY_PATH="target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          ARCHIVE_NAME="nest-${{ matrix.platform_name }}-${{ matrix.arch }}.tar.gz"
          CHECKSUM_NAME="${ARCHIVE_NAME}.sha256"
          WORKING_DIR=$(pwd)
          
          echo "=== Creating archive ==="
          echo "Working directory: ${WORKING_DIR}"
          echo "Binary path: ${BINARY_PATH}"
          echo "Archive name: ${ARCHIVE_NAME}"
          echo "Checksum name: ${CHECKSUM_NAME}"
          
          if [ ! -f "$BINARY_PATH" ]; then
            echo "Error: Binary not found at $BINARY_PATH"
            echo "Checking target directory:"
            ls -la "target/${{ matrix.target }}/release/" || echo "Directory does not exist"
            exit 1
          fi
          
          echo "Binary found, size: $(ls -lh "$BINARY_PATH" | awk '{print $5}')"
          
          # Create archive from binary directory
          cd target/${{ matrix.target }}/release
          ARCHIVE_FULL_PATH="${WORKING_DIR}/${ARCHIVE_NAME}"
          echo "Creating archive at: ${ARCHIVE_FULL_PATH}"
          tar czf "${ARCHIVE_FULL_PATH}" ${{ matrix.binary_name }}
          if [ $? -ne 0 ]; then
            echo "Error: tar command failed"
            exit 1
          fi
          cd "${WORKING_DIR}"
          
          if [ ! -f "${ARCHIVE_NAME}" ]; then
            echo "Error: Archive ${ARCHIVE_NAME} was not created in ${WORKING_DIR}"
            echo "Current directory contents:"
            ls -la | head -20
            exit 1
          fi
          
          echo "Archive created successfully, size: $(ls -lh "${ARCHIVE_NAME}" | awk '{print $5}')"
          
          # Create checksum
          if command -v sha256sum > /dev/null 2>&1; then
            sha256sum ${ARCHIVE_NAME} > ${CHECKSUM_NAME}
          elif command -v shasum > /dev/null 2>&1; then
            shasum -a 256 ${ARCHIVE_NAME} > ${CHECKSUM_NAME}
          else
            echo "Error: Neither sha256sum nor shasum found"
            exit 1
          fi
          
          if [ ! -f "${CHECKSUM_NAME}" ]; then
            echo "Error: Checksum ${CHECKSUM_NAME} was not created"
            exit 1
          fi
          
          echo "=== Archive and checksum created successfully ==="
          ls -lh ${ARCHIVE_NAME} ${CHECKSUM_NAME}
          echo "Checksum content:"
          cat ${CHECKSUM_NAME}

      - name: Create archive (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $ErrorActionPreference = "Stop"
          
          $BINARY_PATH = "target/${{ matrix.target }}/release/${{ matrix.binary_name }}"
          $ARCHIVE_NAME = "nest-${{ matrix.platform_name }}-${{ matrix.arch }}.zip"
          $CHECKSUM_NAME = "${ARCHIVE_NAME}.sha256"
          $WORKING_DIR = Get-Location
          
          Write-Host "Working directory: $WORKING_DIR"
          Write-Host "Binary path: $BINARY_PATH"
          Write-Host "Archive name: $ARCHIVE_NAME"
          
          if (-not (Test-Path $BINARY_PATH)) {
            Write-Error "Error: Binary not found at $BINARY_PATH"
            Write-Host "Current directory contents:"
            Get-ChildItem -Recurse -Filter "nest.exe" | Select-Object FullName
            exit 1
          }
          
          # Get absolute path for archive
          $ARCHIVE_FULL_PATH = Join-Path $WORKING_DIR $ARCHIVE_NAME
          Write-Host "Archive full path: $ARCHIVE_FULL_PATH"
          
          # Change to binary directory
          $BINARY_DIR = Split-Path -Parent (Resolve-Path $BINARY_PATH)
          $BINARY_FILE = Split-Path -Leaf $BINARY_PATH
          Write-Host "Binary directory: $BINARY_DIR"
          Write-Host "Binary file: $BINARY_FILE"
          
          Push-Location $BINARY_DIR
          try {
            # Create archive from binary directory
            Compress-Archive -Path $BINARY_FILE -DestinationPath $ARCHIVE_FULL_PATH -Force
            if (-not $?) {
              Write-Error "Error: Compress-Archive failed"
              exit 1
            }
          } catch {
            Write-Error "Error creating archive: $_"
            exit 1
          } finally {
            Pop-Location
          }
          
          if (-not (Test-Path $ARCHIVE_FULL_PATH)) {
            Write-Error "Error: Archive ${ARCHIVE_NAME} was not created at $ARCHIVE_FULL_PATH"
            exit 1
          }
          
          Write-Host "Archive created successfully"
          
          # Create checksum
          try {
            $HASH = Get-FileHash -Algorithm SHA256 $ARCHIVE_FULL_PATH
            "$($HASH.Hash)  $($ARCHIVE_NAME)" | Out-File -Encoding utf8 $CHECKSUM_NAME
            if (-not $?) {
              Write-Error "Error: Failed to create checksum ${CHECKSUM_NAME}"
              exit 1
            }
          } catch {
            Write-Error "Error creating checksum: $_"
            exit 1
          }
          
          Write-Host "Created archive: ${ARCHIVE_NAME}"
          Write-Host "Created checksum: ${CHECKSUM_NAME}"
          Get-ChildItem ${ARCHIVE_NAME}, ${CHECKSUM_NAME} | Format-Table Name, Length

      - name: Verify files before upload (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          set -e
          ARCHIVE="nest-${{ matrix.platform_name }}-${{ matrix.arch }}.tar.gz"
          CHECKSUM="${ARCHIVE}.sha256"
          
          echo "=== Verifying files before upload ==="
          echo "Current directory: $(pwd)"
          echo "Looking for:"
          echo "  Archive: ${ARCHIVE}"
          echo "  Checksum: ${CHECKSUM}"
          
          echo "=== Files in current directory ==="
          ls -la | head -20
          
          if [ ! -f "${ARCHIVE}" ]; then
            echo "Error: Archive ${ARCHIVE} not found in $(pwd)"
            echo "Searching for archive files:"
            find . -name "*.tar.gz" -type f 2>/dev/null || echo "No .tar.gz files found"
            exit 1
          fi
          
          if [ ! -f "${CHECKSUM}" ]; then
            echo "Error: Checksum ${CHECKSUM} not found in $(pwd)"
            echo "Searching for checksum files:"
            find . -name "*.sha256" -type f 2>/dev/null || echo "No .sha256 files found"
            exit 1
          fi
          
          echo "=== Files verified successfully ==="
          ls -lh ${ARCHIVE} ${CHECKSUM}

      - name: Verify files before upload (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $ErrorActionPreference = "Stop"
          $ARCHIVE = "nest-${{ matrix.platform_name }}-${{ matrix.arch }}.zip"
          $CHECKSUM = "${ARCHIVE}.sha256"
          
          Write-Host "=== Verifying files before upload ==="
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Looking for:"
          Write-Host "  Archive: $ARCHIVE"
          Write-Host "  Checksum: $CHECKSUM"
          
          Write-Host "=== Files in current directory ==="
          Get-ChildItem | Select-Object Name, Length | Format-Table
          
          if (-not (Test-Path $ARCHIVE)) {
            Write-Error "Error: Archive $ARCHIVE not found in $(Get-Location)"
            Write-Host "Searching for archive files:"
            Get-ChildItem -Recurse -Filter "*.zip" -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }
          
          if (-not (Test-Path $CHECKSUM)) {
            Write-Error "Error: Checksum $CHECKSUM not found in $(Get-Location)"
            Write-Host "Searching for checksum files:"
            Get-ChildItem -Recurse -Filter "*.sha256" -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
          }
          
          Write-Host "=== Files verified successfully ==="
          Get-ChildItem $ARCHIVE, $CHECKSUM | Format-Table Name, Length

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nest-${{ matrix.platform_name }}-${{ matrix.arch }}
          path: |
            nest-${{ matrix.platform_name }}-${{ matrix.arch }}.*
          retention-days: 30
          if-no-files-found: error

  package_examples:
    name: Package Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify examples directory exists
        run: |
          if [ ! -d "examples" ]; then
            echo "Error: examples directory not found"
            exit 1
          fi
          echo "Examples directory found"
          ls -la examples/

      - name: Create examples archive
        run: |
          ARCHIVE_NAME="examples.tar.gz"
          CHECKSUM_NAME="${ARCHIVE_NAME}.sha256"
          
          echo "=== Creating examples archive ==="
          
          # Create archive
          tar czf "${ARCHIVE_NAME}" examples/
          if [ $? -ne 0 ]; then
            echo "Error: Failed to create archive"
            exit 1
          fi
          
          echo "Archive created successfully, size: $(ls -lh "${ARCHIVE_NAME}" | awk '{print $5}')"
          
          # Create checksum
          sha256sum ${ARCHIVE_NAME} > ${CHECKSUM_NAME}
          
          if [ ! -f "${CHECKSUM_NAME}" ]; then
            echo "Error: Checksum not created"
            exit 1
          fi
          
          echo "=== Archive and checksum created successfully ==="
          ls -lh ${ARCHIVE_NAME} ${CHECKSUM_NAME}
          echo "Checksum content:"
          cat ${CHECKSUM_NAME}

      - name: Upload examples artifact
        uses: actions/upload-artifact@v4
        with:
          name: examples
          path: |
            examples.tar.gz
            examples.tar.gz.sha256
          retention-days: 30
          if-no-files-found: error

  release:
    name: Create Release
    needs: [build, package_examples]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | cut -d '"' -f 2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Download examples artifact
        uses: actions/download-artifact@v4
        with:
          name: examples
          path: examples-artifact

      - name: List downloaded artifacts
        run: |
          echo "=== Checking artifacts structure ==="
          if [ ! -d "artifacts" ]; then
            echo "Error: artifacts directory does not exist. No artifacts were downloaded."
            echo "This usually means all build jobs failed. Cannot create release."
            exit 1
          fi
          
          echo "=== Artifacts directory contents ==="
          find artifacts -type f -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" | sort || echo "No artifacts found"
          
          echo "=== Artifacts by platform ==="
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "Platform: $(basename $dir)"
              ls -lh "$dir" || echo "  No files in this directory"
            fi
          done
          
          # Check if we have any files at all
          if [ -z "$(find artifacts -type f)" ]; then
            echo "Error: artifacts directory is empty. Cannot create release."
            exit 1
          fi

      - name: Prepare release files
        run: |
          mkdir -p release-files
          
          # Copy all binaries archives and checksums to release-files directory
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec cp {} release-files/ \;
          
          # Copy examples archive and checksum
          if [ -d "examples-artifact" ]; then
            find examples-artifact -type f \( -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} release-files/ \;
            echo "Examples archive added to release files"
          else
            echo "Warning: examples-artifact directory not found"
          fi
          
          echo "=== Release files prepared ==="
          ls -lh release-files/
          
          # Verify we have files
          if [ -z "$(ls -A release-files)" ]; then
            echo "Error: No files prepared for release."
            exit 1
          fi
          
          # Count files
          ARCHIVE_COUNT=$(find release-files -name "*.tar.gz" -o -name "*.zip" | wc -l)
          CHECKSUM_COUNT=$(find release-files -name "*.sha256" | wc -l)
          echo "Archives: $ARCHIVE_COUNT"
          echo "Checksums: $CHECKSUM_COUNT"
          
          if [ "$ARCHIVE_COUNT" -eq 0 ]; then
            echo "Error: No archives found for release."
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          body: |
            ## Release v${{ steps.get_version.outputs.version }}

            ### Installation

            **Linux/macOS:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/quonaro/nest/main/install.sh | bash
            ```

            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/quonaro/nest/main/install.ps1 | iex
            ```

            ### Downloads

            Pre-built binaries for all platforms are available below.

            **Examples:**
            Download `examples.tar.gz` to get the complete examples folder with all configuration examples.

            ### Checksums

            All files include SHA256 checksums for verification.
          files: release-files/*
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup artifacts
        if: always()
        run: |
          rm -rf artifacts/ examples-artifact/ release-files/

