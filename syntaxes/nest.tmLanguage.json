{
    "scopeName": "source.nestfile",
    "name": "Nestfile",
    "patterns": [
        {
            "include": "#comments"
        },
        {
            "include": "#meta"
        },
        {
            "include": "#directives"
        },
        {
            "include": "#command"
        },
        {
            "include": "#templates"
        }
    ],
    "repository": {
        "comments": {
            "patterns": [
                {
                    "name": "comment.line.number-sign.nestfile",
                    "match": "^\\s*#.*$"
                }
            ]
        },
        "command": {
            "patterns": [
                {
                    "begin": "^(\\s*)([A-Za-z0-9_]+)\\s*(\\()",
                    "end": "(\\))\\s*:\\s*$",
                    "beginCaptures": {
                        "2": {
                            "name": "entity.name.function.nestfile"
                        },
                        "3": {
                            "name": "punctuation.definition.parameters.begin.nestfile"
                        }
                    },
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.parameters.end.nestfile"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#parameters"
                        }
                    ]
                },
                {
                    "match": "^(\\s*)([A-Za-z0-9_]+)\\s*:\\s*$",
                    "captures": {
                        "2": {
                            "name": "entity.name.function.nestfile"
                        }
                    }
                }
            ]
        },
        "parameters": {
            "patterns": [
                {
                    "include": "#templates"
                },
                {
                    "match": "\\b(str|bool|num|arr)\\b",
                    "name": "storage.type.nestfile"
                },
                {
                    "match": "\\b(true|false)\\b",
                    "name": "constant.language.boolean.nestfile"
                },
                {
                    "match": "\\!",
                    "name": "keyword.operator.logical.nestfile"
                },
                {
                    "match": "\\|",
                    "name": "punctuation.separator.alias.nestfile"
                },
                {
                    "match": ":",
                    "name": "punctuation.separator.type.nestfile"
                },
                {
                    "match": "=",
                    "name": "keyword.operator.assignment.nestfile"
                },
                {
                    "match": ",",
                    "name": "punctuation.separator.parameter.nestfile"
                },
                {
                    "match": "\\*",
                    "name": "keyword.operator.rest.nestfile"
                },
                {
                    "match": "\"",
                    "name": "string.quoted.double.nestfile"
                },
                {
                    "match": "\\b[a-zA-Z0-9_]+\\b",
                    "name": "variable.parameter.nestfile"
                }
            ]
        },
        "directives": {
            "patterns": [
                {
                    "begin": "^(\\s*)(script|before|after|fallback|finally)((?:\\.[a-zA-Z0-9_]+)*)\\s*(:)\\s*(\\|).*$",
                    "end": "^(?=\\s*[^\\s:#()]+\\s*(?:\\([^)]*\\))?\\s*:)",
                    "beginCaptures": {
                        "2": {
                            "name": "keyword.control.directive.nestfile"
                        },
                        "3": {
                            "name": "storage.modifier.directive.nestfile"
                        },
                        "4": {
                            "name": "punctuation.separator.key-value.nestfile"
                        },
                        "5": {
                            "name": "punctuation.definition.multiline.nestfile"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#script-content"
                        }
                    ]
                },
                {
                    "match": "^(\\s*)(validate)(\\s*:\\s*)([a-zA-Z0-9_]+)\\s+(matches)\\s+(/.+/)$",
                    "captures": {
                        "2": {
                            "name": "keyword.control.directive.nestfile"
                        },
                        "3": {
                            "name": "punctuation.separator.key-value.nestfile"
                        },
                        "4": {
                            "name": "variable.parameter.nestfile"
                        },
                        "5": {
                            "name": "keyword.operator.comparison.nestfile"
                        },
                        "6": {
                            "name": "string.regexp.nestfile"
                        }
                    }
                },
                {
                    "begin": "^(\\s*)(depends)(\\s*:\\s*)",
                    "end": "$",
                    "beginCaptures": {
                        "2": {
                            "name": "keyword.control.directive.nestfile"
                        },
                        "3": {
                            "name": "punctuation.separator.key-value.nestfile"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#depends-list"
                        }
                    ]
                },
                {
                    "match": "^(\\s*)(desc|cwd|env|script|before|after|fallback|finally|depends|validate|logs|privileged|require_confirm|watch)((?:\\.[a-zA-Z0-9_]+)*)(\\s*:\\s*)(.*)$",
                    "captures": {
                        "2": {
                            "name": "keyword.control.directive.nestfile"
                        },
                        "3": {
                            "name": "storage.modifier.directive.nestfile"
                        },
                        "4": {
                            "name": "punctuation.separator.key-value.nestfile"
                        },
                        "5": {
                            "name": "string.unquoted.nestfile",
                            "patterns": [
                                {
                                    "include": "#templates"
                                },
                                {
                                    "include": "#env-vars"
                                }
                            ]
                        }
                    }
                },
                {
                    "match": "^(\\s*)(privileged)\\s*$",
                    "captures": {
                        "2": {
                            "name": "keyword.control.directive.nestfile"
                        }
                    }
                }
            ]
        },
        "script-content": {
            "patterns": [
                {
                    "match": "^\\s+(.+)$",
                    "captures": {
                        "1": {
                            "patterns": [
                                {
                                    "match": "\\b([a-zA-Z_][a-zA-Z0-9_]*)\\s*(?=\\()",
                                    "name": "entity.name.function.nestfile"
                                },
                                {
                                    "include": "#templates"
                                },
                                {
                                    "include": "#env-vars"
                                },
                                {
                                    "name": "string.quoted.double.shell",
                                    "begin": "\"",
                                    "end": "\"",
                                    "beginCaptures": {
                                        "0": {
                                            "name": "punctuation.definition.string.begin.shell"
                                        }
                                    },
                                    "endCaptures": {
                                        "0": {
                                            "name": "punctuation.definition.string.end.shell"
                                        }
                                    },
                                    "patterns": [
                                        {
                                            "include": "#templates"
                                        },
                                        {
                                            "include": "#env-vars"
                                        },
                                        {
                                            "name": "constant.character.escape.shell",
                                            "match": "\\\\."
                                        }
                                    ]
                                },
                                {
                                    "name": "string.quoted.single.shell",
                                    "begin": "'",
                                    "end": "'",
                                    "beginCaptures": {
                                        "0": {
                                            "name": "punctuation.definition.string.begin.shell"
                                        }
                                    },
                                    "endCaptures": {
                                        "0": {
                                            "name": "punctuation.definition.string.end.shell"
                                        }
                                    },
                                    "patterns": [
                                        {
                                            "include": "#templates"
                                        },
                                        {
                                            "include": "#env-vars"
                                        },
                                        {
                                            "name": "constant.character.escape.shell",
                                            "match": "\\\\."
                                        }
                                    ]
                                },
                                {
                                    "name": "keyword.control.flow.shell",
                                    "match": "\\b(if|then|else|elif|fi|case|esac|for|select|while|until|do|done|in)\\b"
                                },
                                {
                                    "name": "support.function.builtin.shell",
                                    "match": "\\b(echo|cd|pwd|ls|cat|grep|find|sort|cut|awk|sed|psql|pg_dump|docker|npm|uv|aerich)\\b"
                                }
                            ]
                        }
                    }
                }
            ]
        },
        "meta": {
            "patterns": [
                {
                    "match": "^(\\s*)(var|const|env)\\s+([A-Za-z0-9_]+)\\s*(=)\\s*(.+)$",
                    "captures": {
                        "2": {
                            "name": "storage.type.variable.nestfile"
                        },
                        "3": {
                            "name": "variable.other.assignment.nestfile"
                        },
                        "4": {
                            "name": "keyword.operator.assignment.nestfile"
                        },
                        "5": {
                            "name": "string.unquoted.nestfile",
                            "patterns": [
                                {
                                    "include": "#templates"
                                },
                                {
                                    "include": "#env-vars"
                                }
                            ]
                        }
                    }
                },
                {
                    "match": "^(\\s*)(var|const|env)\\s+([A-Za-z0-9_]+)\\s*$",
                    "captures": {
                        "2": {
                            "name": "storage.type.variable.nestfile"
                        },
                        "3": {
                            "name": "variable.other.assignment.nestfile"
                        }
                    }
                },
                {
                    "match": "^(\\s*)(function)\\s+([A-Za-z0-9_]+)\\s*(\\([^)]*\\))?\\s*:\\s*$",
                    "captures": {
                        "2": {
                            "name": "storage.type.function.nestfile"
                        },
                        "3": {
                            "name": "entity.name.function.nestfile"
                        }
                    }
                },
                {
                    "begin": "^(\\s*)(import)\\s+(.*)",
                    "end": "$",
                    "beginCaptures": {
                        "2": {
                            "name": "keyword.control.import.nestfile"
                        },
                        "3": {
                            "patterns": [
                                {
                                    "match": "\\b(into)\\b",
                                    "name": "keyword.control.into.nestfile"
                                },
                                {
                                    "match": "\\b(from)\\b",
                                    "name": "keyword.control.from.nestfile"
                                },
                                {
                                    "match": "\\*",
                                    "name": "constant.language.wildcard.nestfile"
                                },
                                {
                                    "match": "([a-zA-Z0-9_./-]+)",
                                    "name": "string.unquoted.filename.nestfile"
                                }
                            ]
                        }
                    }
                }
            ]
        },
        "templates": {
            "patterns": [
                {
                    "name": "meta.embedded.line.nestfile",
                    "begin": "(\\{\\{)\\s*",
                    "end": "\\s*(\\}\\})",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.template-expression.begin.nestfile"
                        }
                    },
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.template-expression.end.nestfile"
                        }
                    },
                    "contentName": "variable.parameter.nestfile"
                },
                {
                    "name": "variable.other.shell-substitution.nestfile",
                    "match": "\\$\\([^)]*\\)"
                }
            ]
        },
        "env-vars": {
            "patterns": [
                {
                    "name": "variable.other.environment.nestfile",
                    "match": "\\$[A-Za-z_][A-Za-z0-9_]*"
                }
            ]
        },
        "depends-list": {
            "patterns": [
                {
                    "include": "#depends-call"
                },
                {
                    "match": "\\b[a-zA-Z0-9_]+\\b",
                    "name": "entity.name.function.nestfile"
                },
                {
                    "match": ",",
                    "name": "punctuation.separator.delimiter.nestfile"
                }
            ]
        },
        "depends-call": {
            "begin": "([a-zA-Z0-9_]+)\\s*(\\()",
            "end": "\\)",
            "beginCaptures": {
                "1": {
                    "name": "entity.name.function.nestfile"
                },
                "2": {
                    "name": "punctuation.definition.parameters.begin.nestfile"
                }
            },
            "endCaptures": {
                "0": {
                    "name": "punctuation.definition.parameters.end.nestfile"
                }
            },
            "patterns": [
                {
                    "match": "\\b([a-zA-Z0-9_]+)\\s*(=)",
                    "captures": {
                        "1": {
                            "name": "variable.parameter.nestfile"
                        },
                        "2": {
                            "name": "keyword.operator.assignment.nestfile"
                        }
                    }
                },
                {
                    "include": "#templates"
                },
                {
                    "match": "\"",
                    "name": "string.quoted.double.nestfile"
                },
                {
                    "match": "\\b(true|false)\\b",
                    "name": "constant.language.boolean.nestfile"
                },
                {
                    "match": "\\b[0-9]+\\b",
                    "name": "constant.numeric.nestfile"
                },
                {
                    "match": ",",
                    "name": "punctuation.separator.parameter.nestfile"
                }
            ]
        }
    }
}